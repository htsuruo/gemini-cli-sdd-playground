# 実装計画

- [ ] 1. プロジェクト基盤のセットアップ
  - [x] 1.1 Node.js/Expressプロジェクトの初期化とサーバー設定
    - Expressサーバーをセットアップし、基本的なリクエストハンドリングを実装する。
    - _Requirements: 全ての要求事項_
  - [x] 1.2 PostgreSQLデータベースへの接続とORM設定
    - Sequelizeを導入し、データベース接続を確立する。
    - ユーザー、2FA、リカバリーコードのモデルを定義する。
    - _Requirements: 全ての要求事項_

- [ ] 2. OAuth 2.0認証機能の実装
  - [x] 2.1 Google OAuth 2.0ストラテジーの実装
    - Passport.jsと`passport-google-oauth20`を導入・設定する。
    - Google認証へのリダイレクトエンドポイントを作成する。
    - _Requirements: 1.1_
  - [x] 2.2 認証コールバック処理とユーザープロビジョニング
    - Googleからのコールバックを処理するエンドポイントを作成する。
    - 受け取ったプロファイル情報を基に、ユーザーを検索または新規作成するロジックを実装する。
    - _Requirements: 1.2, 1.3, 1.4_
  - [x] 2.3 セッション管理の実装
    - 認証成功後にセッションを作成し、ユーザークライアントにセッショントークンを発行する。
    - _Requirements: 1.2_
  - [x] 2.4 エラーハンドリング
    - OAuth認証フローにおける失敗（例：ユーザーによる拒否、無効なコード）を処理する。
    - _Requirements: 1.5_

- [ ] 3. 2要素認証（2FA）機能の実装
  - [ ] 3.1 2FAセットアップ機能の実装
    - `speakeasy`ライブラリを導入する。
    - 2FA有効化のためのシークレットキーとQRコードを生成するエンドポイントを作成する。
    - _Requirements: 2.1_
  - [ ] 3.2 2FA検証と有効化
    - ユーザーが送信したOTPを検証するエンドポイントを作成する。
    - 検証成功後、対象ユーザーの2FAを有効化し、データベースにシークレットを保存する。
    - _Requirements: 2.2, 2.3_
  - [ ] 3.3 リカバリーコードの生成と保存
    - 2FA有効化時に、一回限りのリカバリーコードを複数生成する。
    - ハッシュ化したリカバリーコードをデータベースに保存する。
    - _Requirements: 2.4_

- [ ] 4. 2FAを利用したログインフローの実装
  - [ ] 4.1 ログイン時のOTP要求
    - 通常の認証（OAuth）成功後、ユーザーの2FAが有効かどうかをチェックする。
    - 有効な場合、OTP入力ページへリダイレクトするロジックを実装する。
    - _Requirements: 3.1, 2.5_
  - [ ] 4.2 OTPの検証
    - ユーザーが入力したOTPを検証するロジックを実装する。
    - 複数回失敗した場合のアカウントロックアウト処理を実装する。
    - _Requirements: 3.2, 3.3, 3.4_

- [ ] 5. アカウントリカバリー機能の実装
  - [ ] 5.1 リカバリーコードによるログイン
    - リカバリーコード入力用のエンドポイントを作成する。
    - 送信されたコードをハッシュ化し、データベースの値と比較して検証する。
    - _Requirements: 4.1, 4.2, 4.3_
  - [ ] 5.2 リカバリー後の処理
    - リカバリーコード使用後、そのコードを無効化する。
    - ユーザーに2FAの再設定を促す。
    - _Requirements: 4.2_

- [ ] 6. テストの実装
  - [ ] 6.1 単体テストの作成
    - OTP生成・検証ロジックなど、純粋な関数に対するテストを作成する。
    - _Requirements: 全ての要求事項_
  - [ ] 6.2 結合テストの作成
    - 各APIエンドポイントが、サービスやデータベースと正しく連携して動作することを確認するテストを作成する。
    - _Requirements: 全ての要求事項_
  - [ ] 6.3 E2Eテストの作成
    - ユーザー登録からログイン、2FA設定、リカバリーまでの一連のシナリオをテストする。
    - _Requirements: 全ての要求事項_